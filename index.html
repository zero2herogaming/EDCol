<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Elite FinderÂ â€“Â Debug (Header Key)</title>
  <script src="https://cdn.jsdelivr.net/npm/axios@1/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family:sans-serif; padding:1rem; background:#111; color:#eee; }
    input, button { margin-right:.5rem; }
    pre { background:#222; padding:1rem; max-height:300px; overflow:auto; color:#0f0; }
    label { display:inline-block; margin-bottom:.5rem; }
    .btn { padding:.25rem .5rem; border-radius:.25rem; cursor:pointer; }
    .btn-save { background:#0a0; color:#000; }
    .btn-clear { background:#444; }
    .btn-search { background:#0af; }
    .disabled { background:#555; cursor:not-allowed; }
    .warn { color:#f55; }
  </style>
</head>
<body>

  <h1 style="color:#0af">Elite FinderÂ â€“Â Debug</h1>

  <!-- Credentials -->
  <div>
    <label>CMDR:
      <input id="cmdr" placeholder="yourCommander"/>
    </label>
    <label>APIÂ Key:
      <input id="key" style="width:300px" placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"/>
    </label>
    <button id="save" class="btn btn-save">SaveÂ Creds</button>
    <button id="clear" class="btn btn-clear">ClearÂ Creds</button>
  </div>
  <p id="creds" style="color:#888"></p>

  <!-- Search -->
  <div>
    <label>System:
      <input id="system" placeholder="Sol"/>
    </label>
    <label>Radius:
      <input id="radius" type="number" value="30" style="width:60px"/>
    </label>
    <button id="go" class="btn btn-search disabled" disabled>Search</button>
  </div>
  <p id="warn" class="warn"></p>
  <p id="status"></p>
  <pre id="debug"></pre>

<script>
const WORKER_URL = 'https://snowy-thunder-7b95.zero2herotwitch.workers.dev/';
const STORAGE_KEY = 'inaraCreds';

function $(s){return document.querySelector(s);}
function showCreds(){
  const c = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  if(c.cmdr && c.key){
    $('p#creds').textContent = `Using CMDR="${c.cmdr}"   Key="${c.key}"`;
    enableSearch();
  } else {
    $('p#creds').textContent = 'No credentials saved.';
    disableSearch();
  }
}

$('#save').onclick = ()=>{
  localStorage.setItem(STORAGE_KEY, JSON.stringify({
    cmdr: $('#cmdr').value.trim(),
    key: $('#key').value.trim()
  }));
  showCreds();
};

$('#clear').onclick = ()=>{
  localStorage.removeItem(STORAGE_KEY);
  showCreds();
};

if(localStorage.getItem(STORAGE_KEY)){
  const c = JSON.parse(localStorage.getItem(STORAGE_KEY));
  $('#cmdr').value = c.cmdr;
  $('#key').value  = c.key;
}
showCreds();

// enable/disable Search button
function enableSearch(){
  $('#go').classList.remove('disabled');
  $('#go').disabled = false;
}
function disableSearch(){
  $('#go').classList.add('disabled');
  $('#go').disabled = true;
}

function callInara(events){
  const c = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  const payload = {
    header: {
      appName:'Debug',
      appVersion:'1.0',
      isDeveloped:true,
      apiKey: c.key,            // must be here
      commanderName: c.cmdr     // must be here
    },
    events
  };
  console.log('â†’ REQUEST PAYLOAD:', payload);
  return axios.post(WORKER_URL, payload).then(r=>{
    console.log('â† RAW RESPONSE:', r.data);
    return r.data;
  });
}

$('#go').onclick = async ()=>{
  const c = JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
  if(!c.key||!c.cmdr){
    $('#warn').textContent = 'ğŸš¨ Please set your CMDR name and API key first!';
    return;
  }
  $('#warn').textContent = '';
  $('#status').textContent = 'â³ queryingâ€¦';
  $('#debug').textContent = '';
  try {
    const result = await callInara([{
      eventName:'searchSystemsInSphere',
      eventData:{ systemName:$('#system').value, searchRadius:+$('#radius').value }
    }]);
    $('#debug').textContent = JSON.stringify(result, null, 2);

    if(result.events && result.events[0]){
      $('#status').textContent = 
        `eventStatus: ${result.events[0].eventStatus} â€“ ${result.events[0].eventStatusText}`;
    } else {
      $('#status').textContent = 'âŒ No events array returned';
    }
  } catch(err){
    console.error(err);
    $('#status').textContent = 'âŒ ' + err.message;
  }
};
</script>
</body>
</html>
