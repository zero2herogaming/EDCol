<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Elite System Finder</title>
  <script src="https://cdn.jsdelivr.net/npm/axios@1/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #111; color: #eee; }
    input, button { margin-right: .5rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: .5rem; border: 1px solid #444; }
    th { background: #222; }
    tr:hover { background: #222; }
    a { color: #0af; text-decoration: underline; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h1 class="text-2xl font-bold text-teal-400">Elite System Finder</h1>

  <!-- Search form -->
  <div class="mt-4">
    <input id="system" placeholder="Reference system (e.g. Sol)" class="p-2 rounded bg-[#222] border border-[#444] w-64" />
    <input id="radius" type="number" value="30" min="5" max="150" class="p-2 rounded bg-[#222] border border-[#444] w-20" />
    <input id="maxLs" type="number" value="2000" min="10" class="p-2 rounded bg-[#222] border border-[#444] w-24" />
    <button id="go" class="px-4 py-2 bg-teal-500 hover:bg-teal-600 rounded">Search</button>
  </div>

  <div id="status" class="mt-2 text-sm"></div>

  <!-- Results table -->
  <div id="results-wrap" class="overflow-x-auto">
    <table id="results" class="hidden text-sm">
      <thead>
        <tr><th>System</th><th>Dist (ly)</th><th>Arr Ls</th><th>Water / ELWs</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    (async () => {
      // Configuration
      const WORKER_URL = 'https://snowy-thunder-7b95.zero2herotwitch.workers.dev/';
      const $ = s => document.querySelector(s);
      const status = $('#status');
      const table = $('#results');
      const tbody = table.querySelector('tbody');

      // Utility to add delay (to avoid rate limits)
      const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

      // Inara API request via worker
      async function inaraReq(events) {
        try {
          const payload = { header: { appName: 'SysFinder', appVersion: '1.0', isDeveloped: true }, events };
          const res = await axios.post(WORKER_URL, payload, { headers: { 'Content-Type': 'application/json' } });
          console.log('Inara API Response:', res.data); // Log full response for debugging
          if (res.status !== 200) throw new Error(`Worker request failed with status ${res.status}`);
          return res.data;
        } catch (err) {
          throw new Error(`API request failed: ${err.message}`);
        }
      }

      // Main search handler
      $('#go').onclick = async () => {
        const ref = $('#system').value.trim();
        const radius = Number($('#radius').value) || 30;
        const maxLs = Number($('#maxLs').value) || 2000;
        if (!ref) {
          status.textContent = '⚠️ Enter a system name';
          return;
        }

        status.textContent = '⏳ Querying…';
        tbody.innerHTML = '';
        table.classList.add('hidden');

        try {
          // Step 1: Search systems in sphere
          const sphereRes = await inaraReq([{
            eventName: 'searchSystemsInSphere',
            eventData: { systemName: ref, searchRadius: radius, considerAlef: true }
          }]);

          const ev0 = sphereRes.events?.[0];
          if (!ev0 || ev0.eventStatus !== 200) {
            throw new Error(`Failed to fetch systems: ${ev0?.eventStatusText || 'No event data'}`);
          }

          const systems = ev0.eventData.systems || [];
          if (!systems.length) {
            status.textContent = '⚠️ No systems found in radius';
            return;
          }

          // Step 2: Filter unpopulated systems with water worlds or ELWs
          const hits = [];
          for (let i = 0; i < systems.length; i++) {
            const sys = systems[i];
            status.textContent = `Scanning ${i + 1}/${systems.length}…`;
            if (sys.stationsCount || sys.factionsCount) continue; // Skip populated systems

            const bodiesRes = await inaraReq([{
              eventName: 'getStarSystemBodies',
              eventData: { systemName: sys.name }
            }]);
            await delay(500); // 500ms delay to avoid rate limits

            const bev = bodiesRes.events?.[0];
            if (!bev || bev.eventStatus !== 200) continue;

            const bodies = bev.eventData.bodies || [];
            const ww = bodies.filter(b =>
              b.bodyType === 'Planet' && (
                b.subType === 'Water world' ||
                b.subType === 'Earth-like world'
              )
            );
            if (!ww.length) continue;

            const ls = ww[0].distanceToArrival || 0;
            if (ls >
