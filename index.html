<!doctype html>
<html lang="en" class="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Elite System Finder â€“ Inara Live</title>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/axios@1/dist/axios.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- minimal lightâ€‘mode fallback -->
  <style>
    html.light .dark\:bg-zinc-900 { background: #fafafa; }
    .transition { transition: all .2s; }
  </style>
</head>

<body class="dark:bg-zinc-900 dark:text-zinc-100 bg-white text-zinc-900 min-h-screen flex flex-col items-center gap-6 p-4">

  <!-- Header -->
  <div class="w-full max-w-4xl flex justify-between items-center">
    <h1 class="text-2xl md:text-3xl font-bold text-teal-500">
      Elite&nbsp;System&nbsp;Finder <span class="text-xs align-top">v2Â (Inara)</span>
    </h1>
    <button id="themeToggle" class="p-2 rounded bg-zinc-800 dark:bg-zinc-700 hover:bg-zinc-600 transition" title="Toggle light/dark">
      ğŸŒ™
    </button>
  </div>

  <!-- Credentials dialog -->
  <dialog id="keyDialog" class="rounded lg:w-96 dark:bg-zinc-800 bg-zinc-100 p-4">
    <h2 class="text-lg font-bold mb-2">Enter Inara credentials</h2>
    <p class="text-sm mb-3 dark:text-zinc-300 text-zinc-600">
      Your CMDR name and API key are stored <strong>only</strong> in your browser (localStorage).
      Clear them anytime with the âš™ button.
    </p>
    <input id="cmdrInput" placeholder="CMDR name" class="w-full p-2 mb-2 rounded bg-zinc-900 dark:bg-zinc-900 text-zinc-100" />
    <input id="keyInput" placeholder="Inara API key" class="w-full p-2 mb-4 rounded bg-zinc-900 dark:bg-zinc-900 text-zinc-100" />
    <button id="saveKey" class="bg-teal-500 hover:bg-teal-600 px-4 py-2 rounded">Save</button>
  </dialog>

  <!-- Search form -->
  <form id="queryForm" class="flex flex-col md:flex-row gap-3 items-center w-full max-w-xl">
    <input id="refSystem" required placeholder="Reference system (e.g. Sol)"
           class="flex-1 p-2 rounded dark:bg-zinc-800 bg-zinc-100 border border-zinc-400 dark:border-zinc-600" />
    <input id="radius" type="number" value="30" min="5" max="150" step="1"
           class="w-20 p-2 rounded dark:bg-zinc-800 bg-zinc-100 border border-zinc-400 dark:border-zinc-600" />
    <input id="maxLs" type="number" value="2000" min="10" step="10" title="Max arrival Ls"
           class="w-24 p-2 rounded dark:bg-zinc-800 bg-zinc-100 border border-zinc-400 dark:border-zinc-600" />
    <button class="px-4 py-2 rounded bg-teal-500 hover:bg-teal-600 transition">Search</button>
    <button id="resetCred" type="button" title="Reset stored API key"
            class="px-3 py-2 rounded bg-zinc-700 hover:bg-zinc-600">âš™</button>
  </form>

  <div id="status" class="text-sm h-6"></div>

  <!-- Results -->
  <div class="w-full overflow-x-auto">
    <table id="results" class="w-full text-sm hidden">
      <thead>
        <tr class="dark:bg-zinc-800 bg-zinc-200">
          <th class="p-2 text-left">System</th>
          <th class="p-2">DistÂ (ly)</th>
          <th class="p-2">ArrÂ Ls</th>
          <th class="p-2">WaterÂ /Â ELWs</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
/* ---------- configuration ---------- */
const proxyUrl = 'https://snowy-thunder-7b95.zero2herotwitch.workers.dev/';  // your Cloudflare Worker URL
const LOCAL_KEY = 'inaraCreds';                                              // storage key

/* ---------- helpers ---------- */
const $ = sel => document.querySelector(sel);
const tbody = $('#results tbody');
const status = $('#status');
const table  = $('#results');

/* ---------- theme toggle ---------- */
$('#themeToggle').onclick = () => document.documentElement.classList.toggle('dark');

/* ---------- creds dialog ---------- */
function needCreds() {
  const dlg = $('#keyDialog');
  dlg.showModal();
  $('#saveKey').onclick = () => {
    const obj = {
      cmdr: $('#cmdrInput').value.trim(),
      key:  $('#keyInput').value.trim()
    };
    if (obj.cmdr && obj.key) {
      localStorage.setItem(LOCAL_KEY, JSON.stringify(obj));
      dlg.close();
    }
  };
}
if (!localStorage.getItem(LOCAL_KEY)) needCreds();

$('#resetCred').onclick = () => { localStorage.removeItem(LOCAL_KEY); location.reload(); };

/* ---------- Inara proxy wrapper ---------- */
async function inaraReq(events) {
  const creds = JSON.parse(localStorage.getItem(LOCAL_KEY) || '{}');
  const body  = {
    header: { appName: 'SysFinder', appVersion: '1.0', isDeveloped: true },
    events,
    key: creds.key,
    commanderName: creds.cmdr
  };
  return axios.post(proxyUrl, body);
}

/* ---------- main search ---------- */
$('#queryForm').addEventListener('submit', async e => {
  e.preventDefault();
  tbody.innerHTML = ''; table.classList.add('hidden');
  const ref   = $('#refSystem').value.trim();
  const R     = +$('#radius').value || 30;
  const maxLs = +$('#maxLs').value || 2000;
  status.textContent = 'â³ queryingâ€¦';

  try {
    // 1) sphere search
    const sphere = await inaraReq([{
      eventName: 'searchSystemsInSphere',
      eventData: { systemName: ref, searchRadius: R, considerAlef: true }
    }]);
    const sphereData = sphere.data.events?.[0];
    if (sphereData?.eventStatus !== 'OK') throw new Error('API error (bad key?)');
    const systems = sphereData.eventData.systems || [];
    if (!systems.length) { status.textContent = 'âš  no systems in radius'; return; }

    // 2) filter colonisable
    const candidates = systems.filter(s => s.stationsCount === 0 && s.factionsCount === 0);
    let hits = [], scanned = 0;

    for (const sys of candidates) {
      scanned++;
      if (scanned % 10 === 0) status.textContent = `scanning ${scanned}/${candidates.length}â€¦`;

      const bodiesRes = await inaraReq([{
        eventName: 'getStarSystemBodies',
        eventData: { systemName: sys.name }
      }]);
      const bodiesData = bodiesRes.data.events?.[0];
      if (bodiesData?.eventStatus !== 'OK') continue;

      const bodies = bodiesData.eventData.bodies || [];
      const ww = bodies.filter(b => b.type === 'Water world' || b.subType?.includes('Earth-like'));
      if (!ww.length) continue;

      const ls = ww[0].distanceToArrival ?? 1e9;
      if (ls > maxLs) continue;

      hits.push({
        name: sys.name,
        distance: sys.distance,
        ls,
        ww: ww.map(x => x.name.replace(sys.name + ' ', '')).join(', ')
      });
    }

    if (!hits.length) { status.textContent = 'âœ… API OK â€“ but no matching systems.'; return; }

    // 3) render
    hits.sort((a, b) => a.distance - b.distance);
    hits.forEach(h => {
      const tr = document.createElement('tr');
      tr.className = 'odd:dark:bg-zinc-800 odd:bg-zinc-100 hover:dark:bg-zinc-700 hover:bg-zinc-300';
      tr.innerHTML = `
        <td class="p-2">
          <a class="underline" target="_blank"
             href="https://inara.cz/starsystem/?search=${encodeURIComponent(h.name)}">${h.name}</a>
        </td>
        <td class="p-2 text-center">${h.distance.toFixed(1)}</td>
        <td class="p-2 text-center">${Math.round(h.ls)}</td>
        <td class="p-2">${h.ww}</td>
      `;
      tbody.appendChild(tr);
    });

    table.classList.remove('hidden');
    status.textContent = `âœ… API OK â€“ ${hits.length} systems found.`;
  } catch (err) {
    console.error(err);
    status.textContent = `âŒ ${err.message}`;
  }
});
</script>
</body>
</html>
